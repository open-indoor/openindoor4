<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>OpenIndoor</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <script src='https://unpkg.com/@turf/turf/turf.min.js'></script>
  <!-- <script src="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.css" rel="stylesheet" /> -->
  <script src="https://${APP_DOMAIN_NAME}/mapbox-gl-js/dist/mapbox-gl.js"></script>
  <link href="https://${APP_DOMAIN_NAME}/mapbox-gl-js/dist/mapbox-gl.css" rel="stylesheet" />
  <script src="https://${APP_DOMAIN_NAME}/mapbox-gl-openindoor/dist/mapbox-gl-openindoor.umd.min.js"></script>
  <link href="https://${APP_DOMAIN_NAME}/mapbox-gl-openindoor/dist/mapbox-gl-openindoor.css" rel="stylesheet" />
  <script
    src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.5.1/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet"
    href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.5.1/mapbox-gl-geocoder.css"
    type="text/css" />
    <link rel="stylesheet" href="style.css" type="text/css" />

</head>

<body>
  <div id="map"></div>

  <script>

    let level = 0;
    let country = 'france';
    let bbox = [2.35794, 48.87613, 2.36108, 48.87759];
    let center = [((bbox[2] + bbox[0]) / 2.0), ((bbox[3] + bbox[1]) / 2.0)];
    console.log('center 01:', center);
    let zoom = 17;
    let bearing = 0;
    let pitch = 0;
    const hashParams = new URLSearchParams(window.location.hash.replace('#', ''));

    if (!hashParams.has('map')) {
      if ("geolocation" in navigator) {
        // geolocalization OK
        navigator.geolocation.getCurrentPosition(function (position) {
          center = [position.coords.longitude, position.coords.latitude];
          console.log('center 02:', center);
        });
        navigator.geolocation.watchPosition(function (position) {
          if (map !== undefined) {
            map.setCenter([position.coords.longitude, position.coords.latitude]);
          }
        });
      } else {
        // no geolocalization
      }
    } else {
      let mapParams = hashParams.get('map').split('/');
      console.log('mapParams:', mapParams);

      zoom = (mapParams.length > 0) ? mapParams[0] : zoom;
      center = (mapParams.length > 2) ? [mapParams[1], mapParams[2]] : center;
      console.log('center 03:', center);
      bearing = (mapParams.length > 3) ? mapParams[3] : bearing;
      pitch = (mapParams.length > 4) ? mapParams[4] : pitch;
      level = (mapParams.length > 5) ? mapParams[5] : level;
      console.log("level 01:", level);
    }

    // default
    var map = new mapboxgl.Map({
      container: 'map',
      style: ("/style/openindoorStyle_" + country + ".json"),
      center: center,
      pitch: pitch,
      // maxBounds: geoMaxBounds,
      bearing: bearing,
      zoom: zoom,
      attributionControl: false,
    });

    map.addControl(new mapboxgl.FullscreenControl(), 'bottom-right');

    map.on('moveend', function (event) {
      // console.log(event);
      let center_ = map.getCenter();
      let bearing = map.getBearing();
      let pitch = map.getPitch();
      let level = (typeof openIndoor !== 'undefined') ? openIndoor.level : "0";
      console.log("level 02:", level);
      window.location.hash =
        'map='
        + map.getZoom().toFixed(2)
        + '/' + center_.lng.toFixed(5)
        + '/' + center_.lat.toFixed(5)
        + '/' + Math.round(bearing)
        + '/' + Math.round(pitch)
        + '/' + level
    });

    map.on('load', () => {
      map.addControl(new mapboxgl.NavigationControl(), 'bottom-right');
      fetch("https://${APP_DOMAIN_NAME}/style/indoor/indoorLayers.json")
        .then(response => response.json())
        .then(
          function (response) {
            let indoorLayers = response;
            console.log('indoorLayers:', indoorLayers);

            const INDOOR_SOURCE_ID = "indoor";
            const INDOOR_LAYER_ID = "osm-indoor";
            console.log("level 03:", level);
            const openIndoor = new OpenIndoor(map,
              {
                sourceId: INDOOR_SOURCE_ID,
                // source: {
                //   'type': 'vector',
                //   'url': "https://${API_DOMAIN_NAME}/tileserver/data/" + country + '.json'
                // },
                // source: {
                //   'type': 'geojson',
                //   'data': ...
                // },
                layerId: INDOOR_LAYER_ID,
                layers: indoorLayers,
                level: level
              }
            );
            map.addControl(openIndoor);
          }
        )
        .catch(error => alert("Erreur : " + error));
    })

  </script>

</body>

</html>